<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Details</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/static/css/workout_details.css" rel="stylesheet">
</head>
<body class="bg-light">

<!-- Header -->
<header class="bg-primary text-white text-center py-4">
    {% if not confirm_mode %}
    <!-- Normal Mode -->
    <h1>Workout Details</h1>
    {% if workout %}
    <p>{{ workout.workout_name }}</p>
    {% else %}
    <p>No workout found.</p>
    {% endif %}
    {% else %}
    <!-- Confirmation Mode -->
    <h1>Confirm Your New Workout</h1>
    <p>Please review the generated plan below before saving.</p>
    {% endif %}
</header>

<main class="container my-5">
    <!-- Loading Spinner -->
    <div id="loadingSpinner">
        <div class="spinner"></div>
        <p id="spinnerText">Fetching instructions...</p>
    </div>


    {% if confirm_mode and pending_workout %}
    <!-- ===========================
         CONFIRMATION VIEW
    ============================ -->
    <section>
        <h3 class="text-center">
            {{ pending_workout.workout_name or "Unnamed Workout" }}
        </h3>

        <!-- Show generated movements in a table -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                <tr>
                    <th>Movement</th>
                    <th>Sets</th>
                    <th>Reps</th>
                    <th>Weight (kg)</th>
                    <th>Muscle Groups</th>
                </tr>
                </thead>
                <tbody>
                {% for mv in pending_workout.movements %}
                <tr>
                    <td>{{ mv.name }}</td>
                    <td>{{ mv.sets }}</td>
                    <td>{{ mv.reps }}</td>
                    <td>{{ mv.weight }}</td>
                    <td>
                        {% for mg in mv.muscle_groups %}
                        <span>{{ mg.name }} ({{ mg.impact }}%)<br></span>
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- "Confirm & Save" form -->
        <form method="POST" action="{{ url_for('workout_bp.confirm_workout') }}">
            <button type="submit" class="btn btn-success w-100 mt-3">
                Confirm &amp; Save
            </button>
        </form>
        <form action="{{ url_for('workout_bp.generate_workout') }}" method="POST">
            <input type="hidden" name="target" value="{{ session.get('pending_target', 'General Fitness') }}">
            <button type="submit" class="btn btn-warning">Regenerate Workout</button>
        </form>


    </section>

    {% else %}
    <!-- ===========================
         NORMAL WORKOUT DETAILS
    ============================ -->

    {% if workout %}
    {% if from_select_workout or not workout.is_completed %}

    <hr>
    <!-- Generate Workout Section -->
    <h3 class="text-center text-primary"
        id="toggleGenerateWorkout"
        style="cursor: pointer;">
        Generate Movement Sets
    </h3>
    <section id="generateWorkoutSection" style="display: none;">
        <div class="card mx-auto shadow-lg position-relative" style="max-width: 600px;">
            <!-- Close Button -->
            <button type="button"
                    class="btn-close position-absolute top-0 end-0 m-3"
                    aria-label="Close"
                    onclick="hideGenerateWorkoutSection()">
            </button>
            <div class="card-body">
                <h4 class="card-title text-center mb-4">
                    Customize Your Workout
                </h4>
                <form action="/generate_movements/{{ workout.workout_id }}"
                      method="POST" onsubmit="showLoading()">

                    <!-- Sex Input -->
                    <div class="mb-3">
                        <label for="sex" class="form-label">Sex</label>
                        <select name="sex" id="sex" class="form-select" required>
                            <option value="">-- Select --</option>
                            <option value="male"
                                    {% if user and user.sex==
                            'male' %}selected{% endif %}>
                            Male
                            </option>
                            <option value="female"
                                    {% if user and user.sex==
                            'female' %}selected{% endif %}>
                            Female
                            </option>
                        </select>
                    </div>

                    <!-- Bodyweight Input -->
                    <div class="mb-3">
                        <label for="weight" class="form-label">
                            Bodyweight (kg)
                        </label>
                        <input type="number"
                               id="weight"
                               name="weight"
                               class="form-control"
                               placeholder="Enter your weight"
                               step="0.1"
                               value="{% if user and user.bodyweight %}{{ user.bodyweight }}{% endif %}"
                               required>
                    </div>

                    <!-- Gym Experience Input -->
                    <div class="mb-3">
                        <label for="gymexp" class="form-label">
                            Gym Experience
                        </label>
                        <select name="gymexp" id="gymexp" class="form-select" required>
                            <option value="">-- Select --</option>
                            <option value="beginner"
                                    {% if user and user.gym_experience==
                            'beginner' %}selected{% endif %}>
                            Beginner
                            </option>
                            <option value="intermediate"
                                    {% if user and user.gym_experience==
                            'intermediate' %}selected{% endif %}>
                            Intermediate
                            </option>
                            <option value="advanced"
                                    {% if user and user.gym_experience==
                            'advanced' %}selected{% endif %}>
                            Advanced
                            </option>
                            <option value="expert"
                                    {% if user and user.gym_experience==
                            'expert' %}selected{% endif %}>
                            Expert
                            </option>
                        </select>
                    </div>

                    <!-- Workout Focus Input -->
                    <div class="mb-3">
                        <label for="target" class="form-label">
                            Workout Focus
                        </label>
                        <input type="text"
                               id="target"
                               name="target"
                               class="form-control"
                               placeholder="e.g., upper body, legs"
                               required>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-success w-100">
                            Generate Movements
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <script>
      function showLoading() {
        showSpinnerWithMessage('Customizing your workout...');
      }

      function hideGenerateWorkoutSection() {
        const section = document.getElementById('generateWorkoutSection');
        if (section) {
          section.style.display = 'none';
        }
      }
    </script>

    {% endif %}

    <hr>

    <!-- Movements in Workout -->
    <section>
        <h3 class="text-center">Movements in This Workout</h3>
        <form id="startWorkoutForm" action="/active_workout/{{ workout.workout_id }}" method="GET">
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead class="table-dark">
                    <tr>
                        <th>Movement</th>
                        <th>Instructions</th>
                        <th>Set Details</th>
                        <th>Done</th>
                        <th>Remove</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for wm in workout.workout_movements %}
                    <tr id="row_{{ wm.workout_movement_id }}"
                        class="{{ 'done-row' if wm.done else '' }}">
                        <td>{{ wm.movement.movement_name }}</td>
                        <td>
                            <button type="button"
                                    class="btn btn-sm btn-info"
                                    onclick="fetchInstructions('{{ wm.movement.movement_name }}')">
                                ðŸ“˜ Info
                            </button>
                        </td>
                        <td>
                            <table class="table table-sm mb-0">
                                <thead>
                                <tr>
                                    <th>Set #</th>
                                    <th>Reps</th>
                                    <th>Weight (kg)</th>
                                    <th>Bodyweight?</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for s in wm.sets %}
                                <tr>
                                    <td>{{ s.set_order }}</td>
                                    <td>{{ s.reps|map(attribute='rep_count')|sum }}</td>
                                    <td>{{ s.weights|map(attribute='weight_value')|join(', ') }}</td>
                                    <td>{{ s.weights|map(attribute='is_bodyweight')|join(', ') }}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </td>
                        <td>
                            <input type="checkbox"
                                   name="done_{{ wm.workout_movement_id }}"
                                   class="form-check-input"
                                   {% if wm.done %}checked{% endif %} disabled>
                        </td>
                        <td>
                            <button type="submit"
                                    class="btn btn-danger btn-sm"
                                    formaction="{{ url_for('workout_bp.remove_movement', workout_movement_id=wm.workout_movement_id) }}">
                                Remove
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if not workout.is_completed %}
            <button type="submit" class="btn btn-success w-100 mt-2">
                Start Workout
            </button>
            {% else %}
            <!-- No button displayed for completed workouts -->
            {% endif %}
        </form>

    </section>


    <!-- Muscle Group Impact Section -->
    {% if workout.is_completed %}
    <section class="mt-4">
        <h3 class="text-center text-success">Muscle Group Impact</h3>
        {% if muscle_group_impacts %}
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                <tr>
                    <th>Muscle Group</th>
                    <th>Total Impact</th>
                </tr>
                </thead>
                <tbody>
                {% for mg_name, impact in muscle_group_impacts %}
                <tr>
                    <td>{{ mg_name }}</td>
                    <td>{{ impact|round(2) }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-warning text-center" role="alert">
            No muscle group data available for this workout.
        </div>
        {% endif %}
    </section>
    {% endif %}

    <hr>

    <!-- Add a Movement -->
    {% if not workout.is_completed %}
    <section>
    <span class="toggle-btn btn btn-outline-primary mb-3"
          onclick="toggleNewMovement()">+ Add a Movement</span>

        <form id="newMovementForm" action="/add_movement" method="POST" class="row g-3"
              style="display: none;">
            <input type="hidden" name="workout_id" value="{{ workout.workout_id }}">

            <!-- Radio Buttons: Existing vs. New Movement -->
            <div class="col-md-12">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio"
                           name="movement_option" id="optionExisting"
                           value="existing" checked
                           onchange="toggleMovementFields()">
                    <label class="form-check-label" for="optionExisting">
                        Select Existing Movement
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio"
                           name="movement_option" id="optionNew"
                           value="new"
                           onchange="toggleMovementFields()">
                    <label class="form-check-label" for="optionNew">
                        Create New Movement
                    </label>
                </div>
            </div>

            <!-- Existing Movement Select -->
            <div class="col-md-6" id="existingMovementSection">
                <label for="movement_id" class="form-label">Select Existing Movement:</label>
                <select name="movement_id" id="movement_id" class="form-select"
                        onchange="updateMuscleGroups()">
                    <option value="">-- None --</option>
                    {% for mov in all_movements %}
                    <option value="{{ mov.movement_id }}"
                            data-muscles="{{ mov.muscle_groups | tojson }}">
                        {{ mov.movement_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- New Movement Text Field -->
            <div class="col-md-6" id="newMovementSection" style="display: none;">
                <label for="new_movement_name" class="form-label">New Movement Name:</label>
                <input type="text" id="new_movement_name" name="new_movement_name"
                       class="form-control"
                       placeholder="e.g., Dragon Flags">
            </div>

            <!-- Sets, Reps, Weight -->
            <div class="col-md-2">
                <label for="sets" class="form-label">Sets:</label>
                <input type="number" id="sets" name="sets"
                       class="form-control" min="1" value="1">
            </div>
            <div class="col-md-2">
                <label for="reps_per_set" class="form-label">Reps:</label>
                <input type="number" id="reps_per_set" name="reps_per_set"
                       class="form-control" min="1" value="10">
            </div>
            <div class="col-md-2">
                <label for="weight" class="form-label">Weight (kg):</label>
                <input type="number" id="weight" name="weight"
                       class="form-control" step="0.1" value="0">
            </div>

            <!-- Display Muscle Groups (for existing movement) -->
            <div id="muscleGroupSummary" class="col-md-12 mt-3" style="display: none;">
                <h5>Muscle Groups Affected:</h5>
                <ul id="muscleGroupList" class="list-group"></ul>
            </div>

            <!-- Submit Button -->
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary w-100">
                    Add Movement
                </button>
            </div>
        </form>
    </section>
    {% endif %}


    <!-- Workout Management Section -->
    <h3 class="text-center text-danger" id="manageWorkoutToggle" style="cursor: pointer;">
        Manage Workout
    </h3>
    <div class="workout-management-container">
        <section>
            <div class="d-flex justify-content-center gap-2">
                <form action="/delete_workout/{{ workout.workout_id }}" method="POST">
                    <button type="submit" class="btn btn-danger">Remove Workout</button>
                </form>
                {% if not workout.is_completed %}
                <form action="/complete_workout/{{ workout.workout_id }}" method="POST">
                    <button type="submit" class="btn btn-success">Mark as Completed</button>
                </form>
                {% endif %}
            </div>
        </section>

        <!-- Add Workout Name Form -->
        <section>
            <h3>Workout Name</h3>
            <form action="/update_workout_name/{{ workout.workout_id }}"
                  method="POST" class="row g-3">
                <div class="col-md-8">
                    <label for="workoutName" class="form-label">Name:</label>
                    <input type="text" id="workoutName" name="workoutName"
                           class="form-control"
                           value="{{ workout.workout_name }}"
                           placeholder="Enter workout name"
                           required>
                </div>
                <div class="col-md-2 align-self-end">
                    <button type="submit" class="btn btn-primary">Save Name</button>
                </div>
            </form>
        </section>

        <!-- Workout Details -->
        <section>
            <h3>Update Workout Date</h3>
            <form action="/update_workout_date/{{ workout.workout_id }}"
                  method="POST" class="row g-3">
                <div class="col-md-4">
                    <label for="new_date" class="form-label">Change Date:</label>
                    <input type="date" id="new_date" name="new_date"
                           class="form-control"
                           value="{{ workout.workout_date.strftime('%Y-%m-%d') }}"
                           required>
                </div>
                <div class="col-md-2 align-self-end">
                    <button type="submit" class="btn btn-primary">Update Date</button>
                </div>
            </form>
        </section>
    </div>

    {% else %}
    <!-- If there's no workout object found at all -->
    <div class="alert alert-warning text-center" role="alert">
        No workout to display.
    </div>
    {% endif %}
    {% endif %}

</main>

<!-- Go Back Button -->
<div class="go-back-container">
    <button class="btn btn-secondary go-back-button"
            onclick="location.href='/'">
        Go Back
    </button>
</div>

<!-- Modal for Instructions -->
<div class="modal fade"
     id="instructionsModal"
     tabindex="-1"
     aria-labelledby="instructionsModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="instructionsModalLabel">
                    Movement Instructions
                </h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body" id="instructionsModalBody">
                Loading...
            </div>
        </div>
    </div>
</div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Only set completion_date if it's empty.
    const completionDateInput = document.getElementById('completion_date');
    if (completionDateInput && !completionDateInput.value) {
      const today = new Date().toISOString().split('T')[0];
      completionDateInput.value = today;
    }
  });

  // Toggle "Add a Movement" form
  function toggleNewMovement() {
    const form = document.getElementById('newMovementForm');
    const displayState = form.style.display;
    form.style.display = (displayState === 'none' || displayState === '')
        ? 'block'
        : 'none';
  }

  function toggleMovementFields() {
    const existingSection = document.getElementById('existingMovementSection');
    const newSection = document.getElementById('newMovementSection');
    const optionExisting = document.getElementById('optionExisting');

    if (optionExisting.checked) {
      existingSection.style.display = 'block';
      newSection.style.display = 'none';
    } else {
      existingSection.style.display = 'none';
      newSection.style.display = 'block';
    }
  }

  // Show/hide muscle group details
  function updateMuscleGroups() {
    const movementSelect = document.getElementById('movement_id');
    const selectedOption = movementSelect.options[movementSelect.selectedIndex];
    const muscleGroups = JSON.parse(selectedOption.getAttribute('data-muscles') || '[]');

    const muscleGroupSummary = document.getElementById('muscleGroupSummary');
    const muscleGroupList = document.getElementById('muscleGroupList');

    muscleGroupList.innerHTML = ''; // Clear previous entries

    if (muscleGroups.length > 0) {
      muscleGroups.forEach(mg => {
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item';
        listItem.textContent = `${mg.muscle_group.muscle_group_name}: ${mg.target_percentage}%`;
        muscleGroupList.appendChild(listItem);
      });
      muscleGroupSummary.style.display = 'block';
    } else {
      muscleGroupSummary.style.display = 'none';
    }
  }

  // Toggle workout management
  document.addEventListener('DOMContentLoaded', function() {
    const manageWorkoutToggle = document.getElementById('manageWorkoutToggle');
    if (manageWorkoutToggle) {
      manageWorkoutToggle.addEventListener('click', function() {
        const container = document.querySelector('.workout-management-container');
        container.style.display = (container.style.display === 'none' || container.style.display === '')
            ? 'block'
            : 'none';
      });
    }
  });

  // Toggle generate workout section
  document.addEventListener('DOMContentLoaded', function() {
    const toggleGenerateWorkout = document.getElementById('toggleGenerateWorkout');
    if (toggleGenerateWorkout) {
      toggleGenerateWorkout.addEventListener('click', function() {
        const section = document.getElementById('generateWorkoutSection');
        section.style.display = (section.style.display === 'none' || section.style.display === '')
            ? 'block'
            : 'none';
      });
    }
  });

  // Hide the generate workout section when the close button is clicked
  function hideGenerateWorkoutSection() {
    const section = document.getElementById('generateWorkoutSection');
    if (section) {
      section.style.display = 'none';
    }
  }

  // Example instruction fetch
  function fetchInstructions(movementName) {
    showSpinnerWithMessage('Fetching instructions...');

    fetch(`/get_instructions?movement_name=${encodeURIComponent(movementName)}`).then(response => {
      hideSpinner();
      if (!response.ok) {
        throw new Error('Failed to fetch instructions');
      }
      return response.json();
    }).then(data => {
      if (data.instructions) {
        const modalTitle = document.getElementById('instructionsModalLabel');
        const modalBody = document.getElementById('instructionsModalBody');

        modalTitle.textContent = `Instructions for ${movementName}`;
        modalBody.textContent = data.instructions;

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('instructionsModal'));
        modal.show();
      } else {
        alert('No instructions found for this movement.');
      }
    }).catch(error => {
      hideSpinner();
      console.error('Error fetching instructions:', error);
      alert('Failed to fetch instructions. Please try again later.');
    });
  }

  // Example row highlight for "done" movements
  function toggleRowStatus(rowId, isChecked) {
    const rowElement = document.getElementById(`row_${rowId}`);
    if (isChecked) {
      rowElement.classList.add('done-row');
    } else {
      rowElement.classList.remove('done-row');
    }
  }

  // Example validation before completing workout
  function validateWorkoutCompletion() {
    // Implement your logic here, e.g., ensure at least 1 movement is done
    return true;
  }

  function showSpinnerWithMessage(message) {
    // Find the spinner container and text
    const spinner = document.getElementById('loadingSpinner');
    const spinnerText = document.getElementById('spinnerText');

    // Update the text
    spinnerText.textContent = message;

    // Show the spinner
    spinner.style.display = 'block';
  }

  function hideSpinner() {
    const spinner = document.getElementById('loadingSpinner');
    spinner.style.display = 'none';
  }
</script>

</body>
</html>
